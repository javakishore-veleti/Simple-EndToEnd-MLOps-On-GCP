
name: Assign GCP IAM Roles

on:
  workflow_dispatch: # Manual trigger

jobs:
  assign-iam-roles:
    runs-on: ubuntu-latest
    environment: Google Cloud GCP

    steps:
      # Step 1: Authenticate with Google Cloud
      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v1
        with:
          credentials_json: ${{ secrets.SMPL_E2E_MLOPS_GCP_CREDENTIALS }}

      # Step 2: Assign IAM Roles
      - name: Grant IAM Roles to Service Account
        run: |
          PROJECT_ID="${{ secrets.SMPL_E2E_MLOPS_GCP_PROJECT_ID }}"
          SERVICE_ACCOUNT="e2e-mlops-service-account@${PROJECT_ID}.iam.gserviceaccount.com"

          echo "Granting required IAM roles to $SERVICE_ACCOUNT in project $PROJECT_ID..."

          ROLES=(
            roles/aiplatform.admin
            roles/artifactregistry.admin
            roles/artifactregistry.repoAdmin
            roles/bigquery.admin
            roles/cloudbuild.connectionAdmin
            roles/clouddeploy.admin
            roles/container.admin
            roles/container.clusterAdmin
            roles/storage.objectAdmin
          )

          for ROLE in "${ROLES[@]}"; do
            echo "Assigning $ROLE..."
            gcloud projects add-iam-policy-binding $PROJECT_ID \
              --member="serviceAccount:$SERVICE_ACCOUNT" \
              --role="$ROLE"
          done

          echo "All roles have been assigned successfully."
